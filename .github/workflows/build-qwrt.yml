name: Build QWRT for AX1800 Pro

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc \
            /usr/local/share/boost "$AGENT_TOOLSDIRECTORY"
          sudo apt-get clean
          df -h

      - name: Install build dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y \
            ack antlr3 asciidoc autoconf automake autopoint binutils bison \
            build-essential bzip2 ccache cmake cpio curl device-tree-compiler \
            ecj fastjar flex gawk gettext gcc-multilib g++-multilib git gperf \
            haveged help2man intltool lib32gcc-s1 libc6-dev-i386 libelf-dev \
            libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev \
            libncurses5-dev libncursesw5 libncursesw5-dev libreadline-dev \
            libssl-dev libtool lrzsz mkisofs msmtp nano ninja-build p7zip \
            p7zip-full patch pkgconf python2.7 python3 python3-pip \
            python3-ply python3-pyelftools qemu-utils re2c rsync scons \
            squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip \
            vim wget xmlto xxd zlib1g-dev

      - name: Clone ImmortalWrt source (IPQ60xx / QWRT base)
        run: |
          git clone --depth 1 \
            https://github.com/immortalwrt/immortalwrt.git \
            -b openwrt-23.05 openwrt

      - name: Add luci-theme-argon feed
        working-directory: openwrt
        run: |
          echo "src-git argon https://github.com/jerrykuku/luci-theme-argon.git;master" \
            >> feeds.conf.default

      - name: Update and install feeds
        working-directory: openwrt
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Configure for JDCloud AX1800 Pro
        working-directory: openwrt
        run: |
          cat > .config <<'EOF'
CONFIG_TARGET_qualcommax=y
CONFIG_TARGET_qualcommax_ipq60xx=y
CONFIG_TARGET_qualcommax_ipq60xx_DEVICE_jdc_ax1800-pro=y
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-base=y
CONFIG_PACKAGE_luci-theme-argon=y
EOF
          make defconfig

      - name: Download package sources
        working-directory: openwrt
        run: make download -j$(nproc) || make download -j1

      - name: Build firmware
        working-directory: openwrt
        run: |
          make -j$(nproc) V=s 2>&1 | tee build.log \
            || make -j1 V=s 2>&1 | tee -a build.log

      - name: Identify sysupgrade binary
        id: find_bin
        run: |
          SYSUPGRADE=$(find openwrt/bin/targets -name "*sysupgrade.bin" \
            -type f | head -1)
          echo "sysupgrade_path=${SYSUPGRADE}" >> "$GITHUB_OUTPUT"
          echo "Found: ${SYSUPGRADE}"

      - name: Upload sysupgrade artifact
        uses: actions/upload-artifact@v4
        with:
          name: ax1800-pro-sysupgrade
          path: ${{ steps.find_bin.outputs.sysupgrade_path }}
          if-no-files-found: warn

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: openwrt/build.log
          if-no-files-found: ignore

      - name: Create release with sysupgrade binary
        if: success() && steps.find_bin.outputs.sysupgrade_path != ''
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ github.run_number }}
          name: "AX1800 Pro Firmware Build #${{ github.run_number }}"
          body: |
            Automated QWRT/ImmortalWrt firmware build for **JDCloud AX1800 Pro**

            | Field | Value |
            |-------|-------|
            | Target | qualcommax / ipq60xx |
            | Device | JDCloud AX1800 Pro (jdc_ax1800-pro) |
            | Theme | luci-theme-argon |
            | Source | immortalwrt/immortalwrt (openwrt-23.05) |

            **Flashing notes**
            - Use `*-sysupgrade.bin` to upgrade from an existing OpenWrt/ImmortalWrt install.
            - For initial flash from stock firmware, use U-Boot web recovery with `*-factory.bin`.
          files: ${{ steps.find_bin.outputs.sysupgrade_path }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
